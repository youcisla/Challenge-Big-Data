{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="row mb-5 align-items-center">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-2">
                <li class="breadcrumb-item"><a href="{% url 'home' %}" class="text-decoration-none">Accueil</a></li>
                <li class="breadcrumb-item"><a href="{% url 'predictions' %}"
                        class="text-decoration-none">Prédictions</a></li>
                <li class="breadcrumb-item active" aria-current="page">Comparaison</li>
            </ol>
        </nav>
        <h1 class="fw-bold display-6 mb-0 text-info"><i class="bi bi-bar-chart-line-fill me-2"></i>Comparaison Réel vs
            IA</h1>
        <p class="text-muted lead mt-2">Confrontation des prédictions de l'Oracle avec les résultats officiels
            (Simulation).</p>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card border-0 shadow-sm bg-dark text-white">
            <div
                class="card-header bg-transparent border-bottom border-secondary py-3 d-flex justify-content-between align-items-center">
                <h5 class="fw-bold mb-0 text-white">Tableau Comparatif</h5>
                <!-- Filter Input -->
                <div class="input-group w-auto">
                    <span class="input-group-text bg-secondary border-secondary text-white"><i
                            class="bi bi-search"></i></span>
                    <input type="text" id="compSearch" class="form-control bg-dark border-secondary text-white"
                        placeholder="Filtrer...">
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-dark table-hover mb-0 align-middle" id="compTable">
                        <thead class="bg-black">
                            <tr>
                                <th scope="col" class="ps-4">Pays</th>
                                <th scope="col" class="text-center fw-bold text-warning">Consensus (Moy)</th>
                                <th scope="col" class="text-center text-info">XGBoost (V1)</th>
                                <th scope="col" class="text-center text-success">Random Forest (V2)</th>
                                <th scope="col" class="text-center fw-bold text-white border-start border-secondary">
                                    Résultat Réel</th>
                                <th scope="col" class="text-center text-light">Écart (Consensus)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in comparison %}
                            <tr>
                                <td class="ps-4 fw-bold text-white">
                                    <img src="https://flagcdn.com/24x18/{{ item.country|lower|slice:':2' }}.png"
                                        class="me-2 shadow-sm rounded-1" alt="{{ item.country }}"
                                        onerror="this.style.display='none'">
                                    {{ item.country }}
                                </td>
                                <td class="text-center fw-bold text-warning fs-5">{{ item.predicted }}</td>
                                <td class="text-center text-info fw-semibold">{{ item.predicted_xgb }}</td>
                                <td class="text-center text-success fw-semibold">{{ item.predicted_rf }}</td>
                                <td class="text-center fw-bold text-white fs-5 border-start border-secondary">
                                    {{ item.real }}
                                </td>
                                <td class="text-center">
                                    {% if item.diff > 0 %}
                                    <span class="badge bg-success">+{{ item.diff }} (Performance)</span>
                                    {% elif item.diff < 0 %} <span class="badge bg-danger">{{ item.diff }}
                                        (Déception)</span>
                                        {% else %}
                                        <span class="badge bg-primary">Exact !</span>
                                        {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- DataTables CSS -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">

<!-- Custom CSS for improved contrast -->
<style>
    /* DataTables pagination and controls styling */
    .dataTables_wrapper .dataTables_length,
    .dataTables_wrapper .dataTables_filter,
    .dataTables_wrapper .dataTables_info,
    .dataTables_wrapper .dataTables_paginate {
        color: #f8f9fa !important;
    }

    .dataTables_wrapper .dataTables_length select,
    .dataTables_wrapper .dataTables_filter input {
        background-color: #2b3035 !important;
        border-color: #495057 !important;
        color: #f8f9fa !important;
    }

    .dataTables_wrapper .dataTables_paginate .paginate_button {
        color: #f8f9fa !important;
    }

    .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
        background: #495057 !important;
        color: white !important;
        border-color: #495057 !important;
    }

    .dataTables_wrapper .dataTables_paginate .paginate_button.current {
        background: #0d6efd !important;
        color: white !important;
        border-color: #0d6efd !important;
    }
</style>

<!-- jQuery & DataTables JS -->
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>

<script>
    const iso3ToIso2 = {
        'FRA': 'fr', 'USA': 'us', 'CHN': 'cn', 'GBR': 'gb', 'JPN': 'jp',
        'AUS': 'au', 'ITA': 'it', 'GER': 'de', 'NED': 'nl', 'CAN': 'ca',
        'BRA': 'br', 'NZL': 'nz', 'HUN': 'hu', 'KOR': 'kr', 'RUS': 'ru',
        'ROC': 'ru', 'ESP': 'es', 'UKR': 'ua', 'CUB': 'cu', 'SWE': 'se',
        'SUI': 'ch', 'POL': 'pl', 'DEN': 'dk', 'KEN': 'ke', 'NOR': 'no',
        'JAM': 'jm', 'CZE': 'cz', 'ETH': 'et', 'CRO': 'hr', 'IRI': 'ir',
        'SRB': 'rs', 'AUT': 'at', 'BEL': 'be', 'BUL': 'bg', 'SLO': 'si',
        'TUR': 'tr', 'UZB': 'uz', 'GEO': 'ge', 'TPE': 'tw', 'COL': 'co',
        'GRE': 'gr', 'UGA': 'ug', 'ECU': 'ec', 'IRL': 'ie', 'ISR': 'il',
        'QAT': 'qa', 'BAH': 'bs', 'KOS': 'xk', 'VEN': 've', 'EGY': 'eg',
        'IND': 'in', 'HKG': 'hk', 'SVK': 'sk', 'RSA': 'za', 'ARG': 'ar',
        'KAZ': 'kz', 'MEX': 'mx', 'FIN': 'fi', 'LAT': 'lv', 'EST': 'ee'
    };

    $(document).ready(function () {
        // 1. Initialize DataTables
        const table = $('#compTable').DataTable({
            language: {
                url: '//cdn.datatables.net/plug-ins/1.13.4/i18n/fr-FR.json'
            },
            pageLength: 25,
            order: [[1, 'desc']], // Default sort by Consensus (Col index 1)
            columnDefs: [
                { orderable: false, targets: [0] } // Disable sorting on Flag column if desired, or keep it
            ]
        });

        // 2. Link Custom Search Box to DataTables
        $('#compSearch').on('keyup', function () {
            table.search(this.value).draw();
        });

        // 3. Flags (Native JS Helper used inside table draw if needed, but here simple load is fine)
        document.querySelectorAll('img[onerror]').forEach(img => {
            const row = img.closest('td');
            if (row) {
                const txt = row.innerText.trim();
                const iso3 = txt;
                const iso2 = iso3ToIso2[iso3];
                if (iso2) {
                    img.src = `https://flagcdn.com/24x18/${iso2}.png`;
                    img.style.display = 'inline';
                }
            }
        });
    });
</script>
{% endblock %}